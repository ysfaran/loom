---
import '../styles.css';
import { layout, siteTitle } from '../generated/plugin';
import { routes } from '../generated/routes';
import H1 from '../components/mdx/H1.astro';
import H2 from '../components/mdx/H2.astro';
import H3 from '../components/mdx/H3.astro';
import H4 from '../components/mdx/H4.astro';
import H5 from '../components/mdx/H5.astro';
import H6 from '../components/mdx/H6.astro';
import Link from '../components/mdx/Link.astro';

export function getStaticPaths() {
  return routes
    .filter((route) => route.slug)
    .map((route) => ({
      params: { slug: route.slug }
    }));
}

const slug = typeof Astro.params.slug === 'string' ? `/${Astro.params.slug}` : '/';
const activeRoute = routes.find((route) => route.path === slug);

if (!activeRoute) {
  throw new Error(`No route found for path: ${slug}`);
}

let Content: unknown = null;

if (activeRoute.kind === 'mdx') {
  const modules = import.meta.glob('../../content/**/*.mdx');
  const moduleKey = `../../content/${activeRoute.file}`;
  const loader = modules[moduleKey];

  if (!loader) {
    throw new Error(`Unable to load MDX file: ${activeRoute.file}`);
  }

  const loaded = await loader();
  Content = loaded.default;
}

const components = {
  h1: H1,
  h2: H2,
  h3: H3,
  h4: H4,
  h5: H5,
  h6: H6,
  a: Link
};

const sidebarRoutes = routes.filter((route) => route.showInSidebar);
const rootClasses = ['min-h-screen bg-slate-50 text-slate-900', layout.classNames.root].filter(Boolean).join(' ');
const headerClasses = ['border-b border-slate-200 bg-white px-6 py-4', layout.classNames.header].filter(Boolean).join(' ');
const sidebarClasses = ['border-b border-slate-200 bg-white p-4 md:border-b-0 md:border-r', layout.classNames.sidebar]
  .filter(Boolean)
  .join(' ');
const mainClasses = ['p-6', layout.classNames.main].filter(Boolean).join(' ');
const contentClasses = [
  'prose prose-slate prose-a:text-sky-600 prose-a:no-underline hover:prose-a:underline max-w-none',
  layout.classNames.content
]
  .filter(Boolean)
  .join(' ');
const footerClasses = ['border-t border-slate-200 bg-white px-6 py-3 text-sm text-slate-500', layout.classNames.footer]
  .filter(Boolean)
  .join(' ');
---
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{siteTitle}</title>
  </head>
  <body class={rootClasses}>
    {
      !layout.hideDefaultHeader && (
        <header class={headerClasses}>
          <p class="text-sm font-semibold tracking-wide text-slate-700">{siteTitle}</p>
        </header>
      )
    }
    {
      layout.slots.header.map((slot) => (
        <div set:html={slot} />
      ))
    }
    <div class="grid min-h-[calc(100vh-65px)] grid-cols-1 md:grid-cols-[280px_1fr]">
      {
        !layout.hideDefaultSidebar && (
          <aside class={sidebarClasses}>
            {
              layout.slots.sidebarTop.map((slot) => (
                <div set:html={slot} />
              ))
            }
            <h2 class="mb-3 text-xs font-semibold uppercase tracking-wide text-slate-500">Docs</h2>
            <ul class="grid gap-2">
              {sidebarRoutes.map((route) => <li><a class="text-sm text-slate-900 no-underline hover:text-sky-600" href={route.path}>{route.navLabel}</a></li>)}
            </ul>
            {
              layout.slots.sidebarBottom.map((slot) => (
                <div set:html={slot} />
              ))
            }
          </aside>
        )
      }
      <main class={mainClasses}>
        <article class={contentClasses}>
          {
            activeRoute.mdxDecoration?.beforeContentHtml.map((html) => (
              <div set:html={html} />
            ))
          }
          {activeRoute.mdxDecoration?.replaceContentHtml ? <div set:html={activeRoute.mdxDecoration.replaceContentHtml} /> : null}
          {activeRoute.kind === 'html' ? <div set:html={activeRoute.html ?? ''} /> : null}
          {activeRoute.kind === 'mdx' && !activeRoute.mdxDecoration?.replaceContentHtml && Content ? <Content components={components} /> : null}
          {
            activeRoute.mdxDecoration?.afterContentHtml.map((html) => (
              <div set:html={html} />
            ))
          }
        </article>
      </main>
    </div>
    {
      !layout.hideDefaultFooter && (
        <footer class={footerClasses}>Built with Loom</footer>
      )
    }
    {
      layout.slots.footer.map((slot) => (
        <div set:html={slot} />
      ))
    }
  </body>
</html>
